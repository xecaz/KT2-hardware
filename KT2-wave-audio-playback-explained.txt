# Full digital audio output with the KT2 - a timing nightmare.

During the board inspection of the KT2 a speaker could be found. Seeing the robot made a beep when it started up that
made sense, however as i started mapping out all componenst on the board, a buzzer was also found. 
I restarted it a few times over and over with my head pressed to the speaker and the buzzer. The sound came from the
buzzer. I reverse engineered the buzzer quite fast after this and documented it here:
https://github.com/xecaz/KT2-mpython/blob/main/buzzer.example.txt
and we even made it play a little tune:
https://github.com/xecaz/KT2-mpython/blob/main/titanic.mpy

However, none of that sound came out on the speaker.

5t3v3nk3 also found a JST header on the board we had no clue what it was going to.
After inspecting some early robot prototypes on Kickstarter, we could clearly see that header was ment for the speaker.

During further inspection of the board i noticed a chip on located on U4, marked NS4168 which turns out to be a class-D 
Amplifier that can put out 2.5w. Using a SOT8 clamp i used a multimeter to trace it back to the ESP32-S3 on pins 
GPIO45/0/42. This was the start of a weeks work to reverse engineer the amp on the KT2
 
A little writeup on how this was achieved:

The core key to getting MK2 to play digital audio is exact I2S timing and alignment

* KT’s audio amp and codec expect a very specific I2S frame:
* BCLK = GPIO 0, LRCLK = GPIO 42, SDOUT = GPIO 45
* I2S mode: I2S.TX
* Format: I2S.MONO
* Bit depth: always 16-bit, so 8-bit audio had to be redecoded..
* Sample rate: use whatever the WAV header reports.

Most failures (white noise) came from bit misalignment — the amp was receiving data one or more bits off from LRCLK 
boundaries. I fixed this by bit-shifting test sweeps and locking onto the one alignment that consistently produced 
clean audio (shift=0, invert_lr=False).

Volume scaling and 8-bit expansion

The amp expects signed 16-bit PCM, but many WAVs are 8-bit unsigned (0–255).
To translate correctly:
s = (byte - 128) << 8      # convert to signed 16-bit centered at 0
s = int(s * VOLUME)        # optional gain (1.5–2.0x works)

Then clamp between -32768..32767.
Without this, playback sounds like full-range static because the DAC interprets the unsigned bytes incorrectly.

DMA and buffer stability

Playback glitches or random failures came from starving the I2S DMA buffer.
* I solved this by using an internal buffer (ibuf=4096)
* Feeding aligned 512-byte blocks (multiples of 4)
* Handling short writes (w = audio.write(); if not w: w=0) carefully

That removed underruns, and playback became deterministic.

The Reliable Formula (that worked, because fuck, a lot didn't)
I2S(0,
    sck=Pin(0),
    ws=Pin(42),
    sd=Pin(45),
    mode=I2S.TX,
    bits=16,
    format=I2S.MONO,
    rate=sample_rate,
    ibuf=4096
)
Process:
* Play a 1khz tone from youtube on your laptop: https://www.youtube.com/watch?v=PyD9cMarVJk
* Probe all GPIO pins for the microphone, by looking for something that sounds like the 1khz
  https://github.com/xecaz/KT2-hardware/blob/main/scan.gpio.pins.for.mic.mpy
  GPIO16 was isolated as the mic-input
* Generate a local KT2 1khz sample:
  https://github.com/xecaz/KT2-hardware/blob/main/generate.1khz.wave.mpy
* Play original sample back while listening to the microphone, tweak parameters mentioned above and listen for best result
  https://github.com/xecaz/KT2-hardware/blob/main/large.number.of.sound.tests.mpy
* Then do the same with a pure 1mhz tone for more detailed tuning
  https://github.com/xecaz/KT2-hardware/blob/main/using.1khz.sample.for.tuning.i2s.timing.mpy
* Since i tried for 2 days to get here i wanted a little extra confirmation i was on the right track:
  https://github.com/xecaz/KT2-hardware/blob/main/confirm.1khz.playback.results.mpy
* I then wrote the final player (actually huge fucking shoutout to ChatGPT who did most of the heavy lifting).
  https://github.com/xecaz/KT2-hardware/blob/main/first.working.digital.wave.played.on.kt2.mpy
  this plays the sample found here: https://www.ibiblio.org/pub/multimedia/pc-sounds/48hrs04.wav (classing 48hours sample..)

Getting it working ment reverse engineering the amp, tracing the pins to the ESP32, reverse engineering the mic, 
virtually traching it to the ESP, getting to understand the amp and the is2 implemetation Xiaogui made.

Last weeks i reached out to Wairliving (kickstarter), Xiaogui (initial developer) and the Kamerobotics staff, but
to no avail. The amout of work these guys could have saved me by just answering a few of my questions cant be understated. 
That's the main reason the finally working wav player above is obfuscated and missing all comments. If they want to use
my player, feel free to contact me and id be happy to sell them my code ;)

Another shoutout to 5t3v3nk3 who kept motivating me to dig further and also produced theories about what might be going
on.


// xecaz out.
